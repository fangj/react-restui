'use strict';

var express = require('express');
var multer = require('multer'); // v1.0.5
var path = require('path');
var fs = require('fs-extra');

function makeFileName(originalname) {
	var extname = path.extname(originalname);
	var basename = path.basename(originalname, extname);
	return basename + '-' + Date.now() + extname;
}

function uploadify(app, upload_path) {

	fs.ensureDirSync(upload_path);

	var storage = multer.diskStorage({
		destination: function destination(req, file, cb) {
			cb(null, upload_path);
		},
		filename: function filename(req, file, cb) {
			var fname = makeFileName(file.originalname);
			cb(null, fname);
		}
	});

	var upload = multer({ storage: storage });
	app.use('/uploads', express.static(upload_path));

	app.post('/upload', upload.array('files'), function (req, res, next) {
		var file = req.files[0];
		if (!file) {
			return res.status(400).end("no file");
		}
		res.json({ url: "/uploads/" + file.filename });
	});
}

module.exports = uploadify;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvdXBsb2FkaWZ5L2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSSxVQUFVLFFBQVEsU0FBUixDQUFkO0FBQ0EsSUFBSSxTQUFTLFFBQVEsUUFBUixDQUFiLEMsQ0FBZ0M7QUFDaEMsSUFBSSxPQUFLLFFBQVEsTUFBUixDQUFUO0FBQ0EsSUFBSSxLQUFLLFFBQVEsVUFBUixDQUFUOztBQUVBLFNBQVMsWUFBVCxDQUFzQixZQUF0QixFQUFtQztBQUNsQyxLQUFJLFVBQVEsS0FBSyxPQUFMLENBQWEsWUFBYixDQUFaO0FBQ0EsS0FBSSxXQUFTLEtBQUssUUFBTCxDQUFjLFlBQWQsRUFBMkIsT0FBM0IsQ0FBYjtBQUNBLFFBQU8sV0FBVyxHQUFYLEdBQWlCLEtBQUssR0FBTCxFQUFqQixHQUE0QixPQUFuQztBQUNBOztBQUVELFNBQVMsU0FBVCxDQUFtQixHQUFuQixFQUF1QixXQUF2QixFQUFtQzs7QUFFbEMsSUFBRyxhQUFILENBQWlCLFdBQWpCOztBQUVBLEtBQUksVUFBVSxPQUFPLFdBQVAsQ0FBbUI7QUFDL0IsZUFBYSxxQkFBVSxHQUFWLEVBQWUsSUFBZixFQUFxQixFQUFyQixFQUF5QjtBQUNwQyxNQUFHLElBQUgsRUFBUSxXQUFSO0FBQ0QsR0FIOEI7QUFJL0IsWUFBVSxrQkFBVSxHQUFWLEVBQWUsSUFBZixFQUFxQixFQUFyQixFQUF5QjtBQUNsQyxPQUFJLFFBQU0sYUFBYSxLQUFLLFlBQWxCLENBQVY7QUFDQyxNQUFHLElBQUgsRUFBUyxLQUFUO0FBQ0Q7QUFQOEIsRUFBbkIsQ0FBZDs7QUFVQSxLQUFJLFNBQVMsT0FBTyxFQUFFLFNBQVMsT0FBWCxFQUFQLENBQWI7QUFDQSxLQUFJLEdBQUosQ0FBUSxVQUFSLEVBQW1CLFFBQVEsTUFBUixDQUFlLFdBQWYsQ0FBbkI7O0FBRUEsS0FBSSxJQUFKLENBQVMsU0FBVCxFQUFvQixPQUFPLEtBQVAsQ0FBYSxPQUFiLENBQXBCLEVBQTJDLFVBQVUsR0FBVixFQUFlLEdBQWYsRUFBb0IsSUFBcEIsRUFBMEI7QUFDcEUsTUFBSSxPQUFLLElBQUksS0FBSixDQUFVLENBQVYsQ0FBVDtBQUNBLE1BQUcsQ0FBQyxJQUFKLEVBQVM7QUFDUixVQUFPLElBQUksTUFBSixDQUFXLEdBQVgsRUFBZ0IsR0FBaEIsQ0FBb0IsU0FBcEIsQ0FBUDtBQUNBO0FBQ0MsTUFBSSxJQUFKLENBQVMsRUFBQyxLQUFJLGNBQVksS0FBSyxRQUF0QixFQUFUO0FBQ0YsRUFORDtBQU9BOztBQUVELE9BQU8sT0FBUCxHQUFlLFNBQWYiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTtcclxudmFyIG11bHRlciA9IHJlcXVpcmUoJ211bHRlcicpOyAvLyB2MS4wLjVcclxudmFyIHBhdGg9cmVxdWlyZSgncGF0aCcpO1xyXG52YXIgZnMgPSByZXF1aXJlKCdmcy1leHRyYScpO1xyXG5cclxuZnVuY3Rpb24gbWFrZUZpbGVOYW1lKG9yaWdpbmFsbmFtZSl7XHJcblx0dmFyIGV4dG5hbWU9cGF0aC5leHRuYW1lKG9yaWdpbmFsbmFtZSk7XHJcblx0dmFyIGJhc2VuYW1lPXBhdGguYmFzZW5hbWUob3JpZ2luYWxuYW1lLGV4dG5hbWUpO1xyXG5cdHJldHVybiBiYXNlbmFtZSArICctJyArIERhdGUubm93KCkrZXh0bmFtZTtcclxufVxyXG5cclxuZnVuY3Rpb24gdXBsb2FkaWZ5KGFwcCx1cGxvYWRfcGF0aCl7XHJcblxyXG5cdGZzLmVuc3VyZURpclN5bmModXBsb2FkX3BhdGgpO1xyXG5cclxuXHR2YXIgc3RvcmFnZSA9IG11bHRlci5kaXNrU3RvcmFnZSh7XHJcblx0ICBkZXN0aW5hdGlvbjogZnVuY3Rpb24gKHJlcSwgZmlsZSwgY2IpIHtcclxuXHQgICAgY2IobnVsbCx1cGxvYWRfcGF0aClcclxuXHQgIH0sXHJcblx0ICBmaWxlbmFtZTogZnVuY3Rpb24gKHJlcSwgZmlsZSwgY2IpIHtcclxuXHQgIFx0dmFyIGZuYW1lPW1ha2VGaWxlTmFtZShmaWxlLm9yaWdpbmFsbmFtZSk7XHJcblx0ICAgIGNiKG51bGwsIGZuYW1lKTtcclxuXHQgIH1cclxuXHR9KVxyXG4gXHJcblx0dmFyIHVwbG9hZCA9IG11bHRlcih7IHN0b3JhZ2U6IHN0b3JhZ2UgfSlcclxuXHRhcHAudXNlKCcvdXBsb2FkcycsZXhwcmVzcy5zdGF0aWModXBsb2FkX3BhdGgpKTtcclxuXHJcblx0YXBwLnBvc3QoJy91cGxvYWQnLCB1cGxvYWQuYXJyYXkoJ2ZpbGVzJyksIGZ1bmN0aW9uIChyZXEsIHJlcywgbmV4dCkge1xyXG5cdFx0dmFyIGZpbGU9cmVxLmZpbGVzWzBdO1xyXG5cdFx0aWYoIWZpbGUpe1xyXG5cdFx0XHRyZXR1cm4gcmVzLnN0YXR1cyg0MDApLmVuZChcIm5vIGZpbGVcIik7XHJcblx0XHR9XHJcblx0ICBcdHJlcy5qc29uKHt1cmw6XCIvdXBsb2Fkcy9cIitmaWxlLmZpbGVuYW1lfSk7XHJcblx0fSk7XHJcbn1cclxuXHJcbm1vZHVsZS5leHBvcnRzPXVwbG9hZGlmeTtcclxuIl19